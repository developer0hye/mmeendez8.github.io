<!DOCTYPE html>
<html lang="en">

<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->

  <meta charset="utf-8">
  <title>Miguel Méndez | Export to Github Cache with Docker Buildx</title>
  <meta name="author" content="Miguel Mendez">
  <meta property="og:website" content="Miguel Mendez personal website">
  
  
  <meta name="description" property="og:description" content="Github actions cache is integrated with Docker buildx. Learn how to create a simple pipeline using build-push action and Github Cache. Test the new buildx cache-to exporter!">
  

  
  <meta name="image" property="og:image" content="/assets/posts/2021-07-19-new-docker-cache-is-out/thumbnail.webp">
  

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href='https://fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href=/libs/external/skeleton/normalize.css>
  <link rel="stylesheet" href=/libs/external/skeleton/skeleton.css>
  <link rel="stylesheet" href=/libs/custom/my_css.css>
  <link rel="stylesheet" href=/libs/custom/syntax.css>

  <!-- JQuery
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <script src=/libs/external/jquery-3.1.1.min.js></script>

  <!-- Fontello
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet"
    href=/libs/external/fontello-33e07bd3/css/fa_icons_fontello.css>
  
  <!-- Skeleton tabs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href=/libs/external/skeleton_tabs/skeleton-tabs.css>
  <script src=/libs/external/skeleton_tabs/skeleton-tabs.js></script>

  <!-- Timeline
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href=/libs/external/timeline.css>

  <!-- Scripts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <!--<link rel="stylesheet" href=/libs/external/github-prettify-theme.css>-->
  <script src=/libs/custom/my_js.js></script>

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href=/libs/icon.png>
  <link rel="shortcut icon" type="image/png" href=/libs/icon.png>

  <!-- Google Analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-133014227-1', 'auto');
  ga('send', 'pageview');

</script>
    <!-- Twitter cards -->
  <meta name="twitter:site" content="@https://twitter.com/mmeendez8">
  <meta name="twitter:title" content="Export to Github Cache with Docker Buildx">
  
  
  <meta name="twitter:description" content="Github actions cache is integrated with Docker buildx. Learn how to create a simple pipeline using build-push action and Github Cache. Test the new buildx cache-to exporter!">
  
  

  
  <meta name="twitter:card"  content="summary_large_image">
  <meta name="twitter:image" content="https://mmeendez8.github.io/assets/posts/2021-07-19-new-docker-cache-is-out/thumbnail.webp">
  

  <!-- end of Twitter cards -->
  

</head>

<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">

    <section class="header">
      <div class="row">
        <div class="three columns">
          <a href="/"><img class="u-max-full-width"
              src='/assets/profile-pics/main_circle.webp'></a>
        </div>
        <div class="nine columns main-description">
          <h1>Miguel Méndez</h1>
          <div class="subtitle">
            <p>Machine Learning Research Engineer, Gradiant</p>
            <p>miguelmndez [AT] gmail.com</p>
            <p class="social">
              <a href='https://github.com/mmeendez8' target="_blank">
                <i class="icon-github-circled" aria-hidden="true"></i>
              </a>

              <a href='https://www.linkedin.com/in/miguel-mendez/' target="_blank">
                <i class="icon-linkedin-squared" aria-hidden="true"></i>
              </a>

              <a href='https://twitter.com/mmeendez8' target="_blank">
                <i class="icon-twitter-squared2" aria-hidden="true"></i>
              </a>

              <a href='https://medium.com/@miguelmendez_' target="_blank">
                <i class="icon-medium" aria-hidden="true"></i>
              </a>

              <a href='https://stackoverflow.com/users/8380638/m33n' target="_blank">
                <i class="icon-stackoverflow" aria-hidden="true"></i>
              </a>
            </p>
          </div>
        </div>
      </div>
    </section>

    <div class="navbar-spacer"></div>
    <nav class="navbar">
      <div class="container">
        <ul class="navbar-list">
          <li class="navbar-item"><a class="navbar-link" href=/index.html#bio>Bio</a>
          </li>
          <li class="navbar-item"><a class="navbar-link"
            href=/index.html#news>News</a></li>
          <li class="navbar-item"><a class="navbar-link"
              href=/index.html#posts>Posts</a></li>
          <li class="navbar-item"><a class="navbar-link"
              href=/index.html#resume>Vita</a></li>
          <li class="navbar-item"><a class="navbar-link"
              href=/index.html#publications>Publications</a></li>
          <li class="navbar-item"><a class="navbar-link"
              href=/index.html#other>Other</a></li>
        </ul>
      </div>
    </nav>

    <div class="docs-section post-image">

  
  <div class="title-subtitle">
    <h3>Export to Github Cache with Docker Buildx</h3>
    <h5>We can finally use Docker buildx cache-to gha with build-push action and it is blazingly fast!</h5>
  </div>
  
  
  <div>
    <img src="/assets/posts/2021-07-19-new-docker-cache-is-out/thumbnail.webp" alt=""/>
  </div>
  

  <p>I have recently <a href="/2021/04/23/cache-docker.html">uploaded a post</a> with some tricks for reducing the time you spend when building Docker images on Github Actions. That did indeed work pretty well for me until now, but it was a naive solution while waiting for <a href="https://docs.docker.com/buildx/working-with-buildx/">Docker BuildX</a> integration with Github cache. The wait is over and we do not need to manually cache files since Docker BuildX will do everything as we expected!</p>

<h3 id="1-get-the-basics">1. Get the basics</h3>

<p>You can read <a href="/2021/04/23/cache-docker.html">my previous post</a> to get the whole picture but I also recommend you to visit the official pull requests that lead to this new feature:</p>

<ul>
  <li><a href="https://github.com/docker/buildx/pull/535">This</a> is the buildx code that has been merged for allowing the use of github internal cache</li>
  <li><a href="https://github.com/docker/build-push-action/pull/406#issuecomment-879184394">This</a> draft PR contains an example of how to use it.</li>
</ul>

<p>If you read through all of those you probably realize that we have been waiting for new buildx 0.6 version and buildkit 0.9 to be generally available… but that happened just a few days ago!</p>

<center>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">New BuildKit v0.9.0 and Docker Buildx v0.6.0 releases are out with Github cache backend, OpenTelemetry support, Dockerfile Here-docs, better errors, variable support in mount flags etc. <a href="https://t.co/uo89yvSo5j">https://t.co/uo89yvSo5j</a> <a href="https://t.co/L0QM7stmC5">https://t.co/L0QM7stmC5</a></p>&mdash; Tõnis Tiigi (@tonistiigi) <a href="https://twitter.com/tonistiigi/status/1416161830469201920?ref_src=twsrc%5Etfw">July 16, 2021</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</center>

<p>At this moment we are waiting for Github virtual environments to have new buildx 0.6.0 in Ubuntu base images, but they are generated on weekends and deployed during the week so we might have to wait a week or two before that happens. Anyway we can already test the new feature and add it to our pipelines!</p>

<h3 id="2-simple-example">2. Simple example</h3>

<p>I updated my CI pipeline to support the new feature. I can now remove all conditionals that I was using before to reduce building time when Dockerfile or conda.yaml were not modified. The simplify pipeline would be simply this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Continuous Integration new cache</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build_docker</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Docker Buildx</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/setup-buildx-action@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">version</span><span class="pi">:</span> <span class="s">v0.6.0</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to GitHub Container Registry</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/login-action@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">registry</span><span class="pi">:</span> <span class="s">ghcr.io</span>
          <span class="na">username</span><span class="pi">:</span> <span class="s">mmeendez8</span>
          <span class="na">password</span><span class="pi">:</span> <span class="s">$</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build production image</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/build-push-action@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
          <span class="na">builder</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">file</span><span class="pi">:</span> <span class="s">Dockerfile</span>
          <span class="na">push</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">tags</span><span class="pi">:</span> <span class="s">ghcr.io/mmeendez8/cache_docker/ci_dlc:latest</span>
          <span class="na">cache-from</span><span class="pi">:</span> <span class="s">type=gha</span>
          <span class="na">cache-to</span><span class="pi">:</span> <span class="s">type=gha</span>

  <span class="na">lint_and_test</span><span class="pi">:</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">build_docker</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">container</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">ghcr.io/mmeendez8/cache_docker/ci_dlc:latest</span>
      <span class="na">credentials</span><span class="pi">:</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mmeendez8</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">$</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Lint code</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">pre-commit install</span>
          <span class="s">pre-commit run</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run tests</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">pytest tests</span>
</code></pre></div></div>

<p>Note how <code class="language-plaintext highlighter-rouge">cache-from</code> and <code class="language-plaintext highlighter-rouge">cache-to</code> type is set now to <code class="language-plaintext highlighter-rouge">gha</code> (github action). The first time the action is triggered the cache is empty so Docker will need to build all layers from scratch:</p>

<p style="text-align: center;"><img src="/assets/posts/2021-07-19-new-docker-cache-is-out/empty_cache.webp" alt="" /></p>

<p>But after this cache is full, so we can reuse all our layers in next builds, if the images was not modified, or just some of them when we apply changes to our Dockerfile. Let’s trigger a new build with an empty commit and check the time it needs now:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git commit <span class="nt">--allow-empty</span> <span class="nt">-m</span> <span class="s2">"Test build"</span>
git push
</code></pre></div></div>

<p style="text-align: center;"><img src="/assets/posts/2021-07-19-new-docker-cache-is-out/full_cache.webp" alt="" /></p>

<p>That’s it! It only took 22 seconds to build our image.</p>

<h3 id="conclusion">Conclusion</h3>

<ul>
  <li>
    <p>Docker Buildx is a powerful enhancement and we should try to take full advantage of it</p>
  </li>
  <li>
    <p>It is very simple to use Github Cache with build-push-action now</p>
  </li>
</ul>

<p><em>Any ideas for future posts or is there something you would like to comment? Please feel free to reach out via <a href="https://twitter.com/mmeendez8">Twitter</a> or <a href="https://github.com/mmeendez8">Github</a></em></p>


</div>

    <div class="footer">
      <div class="row">
        <div class="three columns">
          Miguel Méndez
        </div>
        <div class="six columns">
          based on the template by <a href="http://web.media.mit.edu/~msaveski">Martin Saveski</a>
        </div>
        <div class="three columns icons">
          <a href='https://github.com/mmeendez8' target="_blank">
            <i class="icon-github-circled" aria-hidden="true"></i>
          </a>

          <a href='https://www.linkedin.com/in/miguel-mendez/' target="_blank">
            <i class="icon-linkedin-squared" aria-hidden="true"></i>
          </a>

          <a href='https://twitter.com/mmeendez8' target="_blank">
            <i class="icon-twitter-squared" aria-hidden="true"></i>
          </a>

          <a href='https://medium.com/@miguelmendez_' target="_blank">
            <i class="icon-medium" aria-hidden="true"></i>
          </a>

          <a href='https://stackoverflow.com/users/8380638/m33n' target="_blank">
            <i class="icon-stackoverflow" aria-hidden="true"></i>
          </a>
        </div>
      </div>
    </div>

  </div>

  <!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>

</html>
